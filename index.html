<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <script src="https://unpkg.com/d3-simple-slider@0.2.1/build/d3-simple-slider.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">

    <title>World Happiness Report</title>
    
    <style type="text/css">
        
        rect:hover {
            fill: lightblue;
        }
    
    #tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
    }
    
    #tooltip.hidden {
        display: none;
    }
    
    #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
    }
    
        </style>
</head>
<body>

    <h1>World Happiness Report</h1>

    <!-- Sunburst chart -->   
    <div id="div_template"></div>

    <!-- Bubble chart -->
    <div class="bubblechart">
        <div id="explanation" class="info">
            GDP corresponds to how the country's economy affects the happiness of the citizens.
        </div>
        <div id="bubblelegend"></div>
        <div class="buttons">
            <ul id="bubblechartbuttons">
                <li><button class="button bubble_select" value="logGDPPerCapita">GDP</button></li>
                <li><button class="button bubble_select" value="healthyLifeExpectancyAtBirth">Life Expectancy</button></li>
                <li><button class="button bubble_select" value="socialSupport">Social Support</button></li>
                <li><button class="button bubble_select" value="freedomToMakeLifeChoices">Freedom</button></li>
                <li><button class="button bubble_select" value="perceptionsOfCorruption">Perceptions of Corruption</button></li>
            </ul>
        </div>

        <div id="bubble"></div>
        <div id="left">Low GDP</div>
        <div id="right">High GDP</div>
        <!-- <div class="moreinfo">
            <h3 id="country"></h3>
            <p id="happiness"></p>
            <p id="GDP">GDP</p>
            <p id="lifeexpentency"></p>
            <p id="socialsupport"></p>
            <p id="freedom"></p>
        </div> -->
        <div id="slider"></div>

        <div class="info">Go to 2020 on the slider and click on any country to see the break down of the contributors of the happiness score!</div>
        
        <div id="bubblebar"></div>

    </div>
    <script type="text/javascript" src="sunburst.js"></script>
    <script type="text/javascript"  src="bubblechart.js"></script>
    
    <h1> Line Chart </h1>
    
    <iframe width="100%" height="3914" frameborder="0"
  src="https://observablehq.com/embed/aa27d000b573fe1e?cells=viewof+filteredAttr%2Cchart2%2Cchart"></iframe>
    
    <h1> Bar Chart</h1>
    <label>File name (.csv):</label>
    <input type="file" name="inputfile" accept=".csv"
        id="inputfile">
        <br><br>
        <label>Field to Plot:</label>
        <select name="plotlist"  id="plotid">
            <option value="">--Choose the Column Name--</option>
        </select>
        <br>
        <pre id="output" ></pre>
        <div id="tooltip" class="hidden">
            
            <p id="value"> </p>
            <p id="value2"> </p>
        </div>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script type="text/javascript">
            
            function setplotfields(db) {
                var plt = document.getElementById('plotid');
                var xnames = "";
                //remove any existing
                //console.log("options count: " + plt.options.length);
                while (plt.options.length > 1) {
                    plt.remove(plt.options.length -1 );
                }
                var vals = Object.values(db[0]);
                for (let i = 0; i < db.columns.length; i++){
                    if (!isNaN(vals[i])) {
                        plt.add(new Option(db.columns[i],i));
                    } else if (xnames == "") {
                        xnames = db.columns[i];
                    }
                }
                if (xnames == "") xnames = db.columns[0];
                plt.addEventListener('change',function() {
                                     var value = plt.options[plt.selectedIndex].value;
                                     var ynames = plt.options[plt.selectedIndex].text;
                                     console.log("val " + value + "txt " + ynames);
                                     if (value > 0) mainbody(db,xnames,ynames);
                                     });
            }
        function loadusercsv(){
            xnames = "";
            document.getElementById('inputfile')
            .addEventListener('change', function() {
                              var database = [];
                              var fr=new FileReader();
                              fr.onload=function(){
                              //filedata = fr.result;
                              database = d3.csvParse(fr.result);
                              setplotfields(database);
                              //mainbody(database,xnames,ynames);
                              }
                              fr.readAsText(this.files[0]);
                              });
        };
        
        loadusercsv();
        
        function mainbody(datab,xaxisname,yaxisname){
            
            //Width and height of plot, not including scales
            var margin = {top: 30, right: 30, bottom: 90, left: 60};
            var w = window.innerWidth - 2 * ( margin.left + margin.right);
            var h = window.innerHeight - 2 * ( margin.top + margin.bottom);
            h = h - 30;
            if ( w < h) w = h;
            if ( h < 100 ) h = 100;
            if (w < 100) w = 100;
            console.log(`window hgt: ${h} wdt: ${w}`);
            
            console.log('data 0');
            console.log(datab[0]);
            console.log("x " + xaxisname + " y " + yaxisname);
            var maxhappy = 0;
            var maxdata = 0;
            doSomethingWithRows(datab);
            
            function doSomethingWithRows(data){
                console.log("in dosomething");
                console.log(data);
                data.forEach(function(row){
                             if (+row[yaxisname] > maxdata) maxdata = row[yaxisname];
                             if (row.Happiness > maxhappy) maxhappy = row.Happiness;
                             });
                             console.log("max "+ yaxisname + " = " + maxhappy);
            }
            
            var labels = datab.map(function(d) { return d[xaxisname]; });
            console.log(labels);
            var xScale = d3.scaleBand()
            .domain(d3.range(datab.length))
            .rangeRound([0, w])
            .paddingInner(0.05);
            
            let xAxisGenerator = d3.axisBottom(xScale);
            xAxisGenerator.tickFormat((d,i) => labels[i]);
            
            var yScale = d3.scaleLinear()
            .domain([0, maxdata])
            .range([h, 0]);
            let yAxisGenerator = d3.axisLeft(yScale);
            
            //Create SVG element
            var svg = d3.select("body")
            .append("svg")
            .attr("width", w  + margin.left + margin.right)
            .attr("height", h  + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");
                  //x axis
                  svg.append("g")
                  .attr("transform", "translate(0, " + h  +")")
                  .call(xAxisGenerator)
                  .selectAll("text")
                  .attr("transform", "translate(-10,0)rotate(-45)")
                  .style("text-anchor", "end");
                  //y axis
                  svg.append("g")
                  .call(yAxisGenerator);
                  
                  // Add X axis label:
                  svg.append("text")
                  .attr("text-anchor", "middle")
                  .attr("x", (w / 2))
                  .attr("y", h + margin.bottom  - 20)
                  .style("font-size", "20px" )
                  .text(xaxisname)
                  
                  // Y axis label:
                  svg.append("text")
                  .attr("text-anchor", "middle")
                  .attr("transform", "rotate(-90)")
                  .attr("x", -(h / 2) )
                  .attr("y", -(margin.left- 25) )
                  .style("font-size", "20px")
                  .text(yaxisname)
                  
                  //Create bars
                  svg.selectAll("rect")
                  .data(datab)
                  .enter()
                  .append("rect")
                  .attr("x", function(d, i) {return xScale(i);})
                  .attr("y", function(d) {return yScale(d[yaxisname]);})
                  .attr("width", xScale.bandwidth())
                  .attr("height", function(d) {  return h - yScale(d[yaxisname]); })
                  .attr("val", function(d) {
                        return d[xaxisname] + " : " + yaxisname + " = " + d[yaxisname] +" <br>Happiness = " + d.Happiness +"<br>"  })
                        .attr("val2", function(d) {
                              return " " })
                              .attr("fill", function(d) {
                                    var blu = 0;
                                    var grn = 0;
                                    if ( !isNaN(d[yaxisname])) blu = Math.round(255 * d[yaxisname]/ maxhappy);
                                    if (blu > 255) blu = 255;
                                    if ( blu < 0) blu = 0;
                                    grn = 255 - blu;
                                    //return "rgb(0, " + grn + " , " + blu + ")";
                                    return d3.interpolateInferno(d.Happiness/(maxhappy))
                                    })
                                    .on("mouseover", function(event,d) {
                                        
                                        //Get this bar's x/y values, then augment for the tooltip
                                        //var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.bandwidth() / 2;
                                        //var yPosition = parseFloat(d3.select(this).attr("y")) / 2 + h / 2;
                                        //Update the tooltip position and value
                                        d3.select("#tooltip")
                                        .style("left", event.pageX + "px")
                                        .style("top",  event.pageY + "px")
                                        document.getElementById("value").innerHTML = d3.select(this).attr("val")
                                        document.getElementById("value2").innerHTML = d3.select(this).attr("val2")
                                        
                                        //Show the tooltip
                                        d3.select("#tooltip").classed("hidden", false);
                                        
                                        })
                                        .on("mouseout", function() {
                                            
                                            //Hide the tooltip
                                            d3.select("#tooltip").classed("hidden", true);
                                            
                                            })
                                            .on("click", function() {
                                                sortBars();
                                                });
                                                
                                                //Define sort order flag
                                                var sortOrder = false;
                                                
                                                //Define sort function
                                                var sortBars = function() {
                                                    
                                                    //Flip value of sortOrder
                                                    sortOrder = !sortOrder;
                                                    svg.selectAll("rect")
                                                    .sort(function(a, b) {
                                                          if (sortOrder) {
                                                          return d3.ascending(+a[yaxisname], +b[yaxisname]);
                                                          } else {
                                                          return d3.ascending(+a.Happiness, +b.Happiness);
                                                          }
                                                          })
                                                          .transition()
                                                          .delay(function(d, i) {
                                                                 return i * 50;
                                                                 })
                                                                 .duration(1000)
                                                                 .attr("x", function(d, i) {
                                                                       labels[i] = d[xaxisname];
                                                                       return xScale(i);
                                                                       });
                                                                       svg.select("g").call(xAxisGenerator);
                                                };
        };
        </script>
        

</body>

